name: Code Quality & Security Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 pylint bandit mypy safety
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: Run Black (Code Formatter Check)
      run: |
        black --check --diff .
      continue-on-error: false

    - name: Run isort (Import Sorting Check)
      run: |
        isort --check-only --diff .
      continue-on-error: false

    - name: Run Flake8 (Linting)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: false


    - name: Run Bandit (Security Linting)
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -ll
      continue-on-error: true

    - name: Run MyPy (Type Checking)
      run: |
        mypy . --ignore-missing-imports --no-strict-optional
      continue-on-error: true

    - name: Run Safety Check (Dependency Vulnerabilities)
      run: |
        safety check --json || true
      continue-on-error: true

    - name: Upload Bandit Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: bandit-security-report
        path: bandit-report.json

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        extra_args: --only-verified --json

    - name: Run detect-secrets
      run: |
        pip install detect-secrets
        detect-secrets scan --baseline .secrets.baseline || true
        detect-secrets audit .secrets.baseline || true
      continue-on-error: true

  sast-analysis:
    name: SAST Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/owasp-top-ten
          p/python
      continue-on-error: true

  dockerfile-check:
    name: Dockerfile Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        ignore: DL3008,DL3009
      continue-on-error: true

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Run pip-audit
      run: |
        pip install pip-audit
        if [ -f requirements.txt ]; then pip-audit --requirement requirements.txt || true
      continue-on-error: true

    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'project-name'
        path: '.'
        format: 'HTML'
      continue-on-error: true

    - name: Upload Dependency Check Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: reports

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [code-quality, secret-scanning, sast-analysis, dockerfile-check, dependency-check]
    if: always()
    
    steps:
    - name: Check Results
      run: |
        echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "✅ Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "✅ Secret Scanning: ${{ needs.secret-scanning.result }}" >> $GITHUB_STEP_SUMMARY
        echo "✅ SAST Analysis: ${{ needs.sast-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "✅ Dockerfile Check: ${{ needs.dockerfile-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "✅ Dependency Check: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
